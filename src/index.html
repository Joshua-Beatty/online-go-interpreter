<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Online Go Interpreter</title>
    <script src="build/wasm_exec.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        /* This registers the global 
        type Result =
        | { success: true; output: string }
        | { success: false; message: string; output: string };
        function run(input: string, onComplete: (result: Result) => void): { async: true }
        */

        // Global callback for streaming output from Go
        // This must be defined before WASM initialization
        window.__goStreamOutput = function (data) {
            const outputContainer = document.getElementById('output-container');
            if (outputContainer) {
                // Append the new data to the output container
                const textNode = document.createTextNode(data);
                outputContainer.appendChild(textNode);
            }
        };

        const go = new Go();

        // Load WASM from multiple chunk files
        async function loadWasmChunks() {
            const chunks = [];
            let chunkIndex = 0;

            // Fetch all chunks
            while (true) {
                try {
                    const response = await fetch(`build/main.wasm.part${chunkIndex}`);
                    if (!response.ok) {
                        // No more chunks
                        break;
                    }

                    // Check if we got HTML instead of binary data (Cloudflare Pages fallback)
                    const contentType = response.headers.get('content-type') || '';
                    if (contentType.includes('text/html')) {
                        // This is the index page, not a WASM chunk - we're done
                        break;
                    }

                    const arrayBuffer = await response.arrayBuffer();
                    chunks.push(new Uint8Array(arrayBuffer));
                    chunkIndex++;
                } catch (error) {
                    // No more chunks
                    break;
                }
            }

            if (chunks.length === 0) {
                throw new Error('No WASM chunks found!');
            }

            // Calculate total size
            const totalSize = chunks.reduce((sum, chunk) => sum + chunk.length, 0);
            console.log(`Loaded ${chunks.length} WASM chunks, total size: ${(totalSize / (1024 * 1024)).toFixed(2)}MB`);

            // Concatenate all chunks into a single Uint8Array
            const wasmBytes = new Uint8Array(totalSize);
            let offset = 0;
            for (const chunk of chunks) {
                wasmBytes.set(chunk, offset);
                offset += chunk.length;
            }

            return wasmBytes;
        }

        // Initialize WASM
        loadWasmChunks()
            .then(wasmBytes => WebAssembly.instantiate(wasmBytes, go.importObject))
            .then(result => {
                go.run(result.instance);
            })
            .catch(error => {
                console.error('Failed to load WASM:', error);
            });
    </script>
</head>

<body>

    <header>
        <h1>Go Interpreter</h1>
        <button id="run-btn">Run Code</button>
    </header>
    <div id="main-container">
        <div id="editor-container"></div>
        <div id="output-container"></div>
    </div>
    <footer>
        <a href="#" id="about-link">About</a>
    </footer>

    <!-- Load Monaco Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' } });

        require(['vs/editor/editor.main'], function () {
            const editor = monaco.editor.create(document.getElementById('editor-container'), {
                value: [
                    'package main',
                    '',
                    'import (',
                    '\t"fmt"',
                    '\t"time"',
                    ')',
                    '',
                    'func main() {',
                    '\tfor i := 1; i <= 5; i++ {',
                    '\t\tfmt.Printf("Line %d\\n", i)',
                    '\t\ttime.Sleep(500 * time.Millisecond)',
                    '\t}',
                    '\tfmt.Println("Done!")',
                    '}'
                ].join('\n'),
                language: 'go',
                theme: 'vs-dark',
                automaticLayout: true,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                scrollbar: {
                    alwaysConsumeMouseWheel: false
                }
            });

            document.getElementById('run-btn').addEventListener('click', () => {
                const code = editor.getValue();
                const outputContainer = document.getElementById('output-container');
                outputContainer.innerHTML = 'Running...';
                outputContainer.className = '';

                // Small delay to allow UI to update
                setTimeout(() => {
                    try {
                        if (typeof run !== 'function') {
                            throw new Error("WASM not loaded yet or 'run' function missing.");
                        }

                        // Clear output before running to show streamed output
                        outputContainer.innerHTML = '';

                        // Call run with a completion callback
                        const result = run(code, (finalResult) => {
                            // This callback is invoked when execution completes
                            if (finalResult.success) {
                                // Output was already streamed, just set success class
                                outputContainer.className = 'output-success';
                            } else {
                                // Clear streamed output and show error
                                outputContainer.innerHTML = '';

                                const messageSpan = document.createElement('div');
                                messageSpan.textContent = finalResult.message;
                                messageSpan.className = 'error-message';
                                outputContainer.appendChild(messageSpan);

                                if (finalResult.output) {
                                    const outputSpan = document.createElement('div');
                                    outputSpan.textContent = finalResult.output;
                                    outputContainer.appendChild(outputSpan);
                                }
                                outputContainer.className = '';
                            }
                        });

                        // Check if the run function returned async indicator
                        if (!result || !result.async) {
                            // Fallback for synchronous execution (shouldn't happen)
                            console.warn('Run function did not return async indicator');
                        }
                    } catch (e) {
                        outputContainer.textContent = "Error: " + e.message;
                        outputContainer.className = 'output-error';
                    }
                }, 10);
            });

            document.getElementById('about-link').addEventListener('click', (e) => {
                e.preventDefault();
                Swal.fire({
                    title: 'About',
                    html: `
                        <div class="about-content">
                            <p>
                                Powered by <a href="https://github.com/traefik/yaegi" target="_blank">Yaegi</a> and WebAssembly.
                                <br>
                                This interpreter runs entirely in your browser with no network calls.
                            </p>
                            <div class="about-footer">
                                <a href="https://github.com/Joshua-Beatty/online-go-interpreter" target="_blank">Github</a>
                                <br>
                                <a href="https://joshbeatty.me" target="_blank">About Me</a>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'Close',
                    background: '#1e1e1e',
                    color: '#d4d4d4',
                    confirmButtonColor: '#0e639c',
                    customClass: {
                        icon: 'swal2-icon-small',
                        popup: 'swal2-dark-popup'
                    }
                });
            });
        });
    </script>
</body>

</html>